name: Production_Infrastructure_Monitor

on:
  schedule:
    - cron: '0 */2 * * *' # Schedule: Every 2 hours
  workflow_dispatch:

jobs:
  system-check:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      # 1. Terminate Stale Sessions (Prevent overlap)
      - name: Prune Stale Processes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          runs=$(gh run list --repo ${{ github.repository }} --status in_progress --json databaseId --jq ".[] | select(.databaseId != ${{ github.run_id }}) | .databaseId")
          for run_id in $runs; do
            gh run cancel $run_id --repo ${{ github.repository }}
          done

      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      # 2. Install Required Libraries
      - name: Install Dependencies
        run: pip install requests telethon

      # 3. Restore Security Context (Session File)
      - name: Restore Session Cache
        env:
          CACHE_BLOB: ${{ secrets.CACHE_DB_B64 }}
        run: |
          # [SỬA] Xuất ra file monitor_cache.session để khớp với code Python
          echo "$CACHE_BLOB" | base64 -d > monitor_cache.session

      # 4. Execute Monitoring Script (Max runtime: 6 hours)
      - name: Execute Diagnostics
        env:
          AWS_CLUSTER_ID: ${{ secrets.AWS_CLIENT_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ALERT_NOTIFICATION_SMS: ${{ secrets.ALERT_PHONE }}
        timeout-minutes: 360
        run: python ci_test.py
